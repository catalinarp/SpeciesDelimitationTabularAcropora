#!/bin/bash

### ASTRAL extended species tree analyses ###
# 1. Copy fasta files to new dir using a list of the loci present on all of the samples:

NAMES=( `cat "Laninsky_phasedloci_ALLsamples.txt" `)

for i in "${NAMES[@]}"; do 
   cp /Projects/Speciesdelimitation_tabularAcropora/TargetCapture/Laninsky_Phasing/gblocks_untrimmed-mafft-fasta-exon/$i \
	working_fasta210/ ;
done

for i in "${NAMES[@]}"; do 
   cp /Projects/Speciesdelimitation_tabularAcropora/TargetCapture/Laninsky_Phasing/gblocks_untrimmed-mafft-fasta-uce/$i \ \
	working_fasta210/ ;
done


# 2. Obtain individual gene trees with phased allele sequences using IQtree 2.0.3:
# Find the best model, use UFBoot(optimised), fast local bootstrap probability method, SH-like approximate likelihood ratio test and symmetry:

for i in *.fasta; do
	iqtree -s $i -alrt 1000 -B 1000 -bnni -lbp 1000 -pre "$i"_cps2 -m MFP+MERGE;
done


# 3. Remove branches with branches with local posterior support (LPS) lower than 10% using Newick utilities:

for i in uce*_cps2.treefile; do
	 nw_ed $i 'i & b<=10' o > "$i"-BS10.tre ;
done

cat exon*-BS10.tre > gblocks-untrimmed-exon1022.tree

cat uce*-BS10.tre > gblocks-untrimmed-uce867.tree

cat gblocks-untrimmed-exon1022.tree gblocks-untrimmed-uce867.tree > gblocks-untrimmed-all.tree


# 4. Run ASTRAL:
## A. Only for exon-derived loci:
## Constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-exon1022.tree \
	-o gblocks-untrimmed-exon1022-speciestree-multiind.tre \
	-a 3species.txt \
	2> gblocks-untrimmed-exon1022-speciestree-multiind.log
	
## Without constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-exon1022.tree \
	-o gblocks-untrimmed-exon1022-speciestree.tre \
	2> gblocks-untrimmed-exon1022-speciestree.log

## B. Only for UCE-derived loci:
## Constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-uce867.tree \
	-o gblocks-untrimmed-uce867-speciestree-multiind.tre \
	-a 3species.txt \
	2> gblocks-untrimmed-uce867-speciestree-multiind.log

## Without constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-uce867.tree \
	-o gblocks-untrimmed-uce867-speciestree.tre \
	2> gblocks-untrimmed-uce867-speciestree.log

## C. Using the complete dataset of coserved elemenst: UCE and exon derived
## Constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-all.tree \
	-o gblocks-untrimmed-all-speciestree-multiind.tre \
	-a 3species.txt \
	2> gblocks-untrimmed-all-speciestree-multiind.log

## Without constraining each morpho-species to be monophyletic:
java -jar /Applications/Academic_software/ASTRAL/Astral/astral.5.7.3.jar \
	-i gblocks-untrimmed-all.tree \
	-o gblocks-untrimmed-all-speciestree.tre \
	2> gblocks-untrimmed-all-speciestree.log
